# Hydrus Tagger

ä¸€ä¸ªåŸºäº WD14 Tagger çš„ Hydrus å›¾ç‰‡è‡ªåŠ¨æ ‡ç­¾å·¥å…·ï¼Œæ”¯æŒå®šæ—¶æŒç»­è¿è¡Œã€‚

## åŠŸèƒ½ç‰¹æ€§

- ğŸ¤– ä½¿ç”¨ WD14 Tagger æ¨¡å‹è‡ªåŠ¨ä¸º Hydrus ä¸­çš„å›¾ç‰‡æ·»åŠ æ ‡ç­¾
- â° æ”¯æŒ crontab é£æ ¼çš„å®šæ—¶è°ƒåº¦ï¼ˆå¦‚ `*/5 * * * *` æ¯ 5 åˆ†é’Ÿï¼‰
- ğŸ“ å®Œæ•´çš„æ—¥å¿—ç³»ç»Ÿï¼Œè‡ªåŠ¨ä¿å­˜åˆ° `logs/` ç›®å½•
- ğŸ”„ æŒç»­è¿è¡Œæ¨¡å¼ï¼Œé€‚åˆå®¹å™¨åŒ–éƒ¨ç½²
- ğŸ›¡ï¸ å®Œå–„çš„é”™è¯¯å¤„ç†ï¼Œå•ä¸ªæ–‡ä»¶å¤±è´¥ä¸å½±å“æ•´ä½“è¿è¡Œ
- ğŸ“Š è¿è¡Œç»Ÿè®¡åŠŸèƒ½ï¼Œè®°å½•æˆåŠŸ/å¤±è´¥æ•°é‡

## å®‰è£…

### 1. å…‹éš†ä»“åº“

```bash
git clone https://github.com/your-username/wd-hydrus-tagger.git
cd wd-hydrus-tagger
```

### 2. å®‰è£…ä¾èµ–

```bash
pip install -r requirements.txt
```

### 3. é…ç½®

å¤åˆ¶å¹¶ç¼–è¾‘é…ç½®æ–‡ä»¶ï¼š

```bash
cp config.json.example config.json
# æˆ–ç›´æ¥ç¼–è¾‘ config.json
```

ç¼–è¾‘ `config.json` æ–‡ä»¶ï¼Œé…ç½®ä»¥ä¸‹å†…å®¹ï¼š

- **schedule**: crontab è¡¨è¾¾å¼ï¼Œå®šä¹‰è¿è¡Œé¢‘ç‡
  - `*/5 * * * *` - æ¯ 5 åˆ†é’Ÿ
  - `0 * * * *` - æ¯å°æ—¶
  - `0 */2 * * *` - æ¯ 2 å°æ—¶
  - `0 0 * * *` - æ¯å¤©åˆå¤œ
- **hydrus**: Hydrus API é…ç½®
  - `host`: Hydrus æœåŠ¡å™¨åœ°å€
  - `api_key`: API å¯†é’¥
  - `tag_service`: æ ‡ç­¾æœåŠ¡åç§°
- **model**: æ¨¡å‹é…ç½®
  - `repo`: æ¨¡å‹ä»“åº“åç§°
  - `general_thresh`: é€šç”¨æ ‡ç­¾é˜ˆå€¼
  - `character_thresh`: è§’è‰²æ ‡ç­¾é˜ˆå€¼
  - `general_mcut_enabled`: æ˜¯å¦å¯ç”¨ MCut é˜ˆå€¼
  - `character_mcut_enabled`: æ˜¯å¦å¯ç”¨è§’è‰² MCut é˜ˆå€¼
- **search_tags**: æœç´¢æ ‡ç­¾åˆ—è¡¨
- **logging**: æ—¥å¿—é…ç½®
  - `level`: æ—¥å¿—çº§åˆ« (DEBUG, INFO, WARNING, ERROR)
  - `log_dir`: æ—¥å¿—ç›®å½•

### 4. è¿è¡Œ

```bash
python run.py
```

ç¨‹åºä¼šæŒç»­è¿è¡Œï¼ŒæŒ‰ç…§é…ç½®çš„ crontab è¡¨è¾¾å¼å®šæ—¶æ‰§è¡Œæ ‡ç­¾ä»»åŠ¡ã€‚

## Crontab è¡¨è¾¾å¼è¯´æ˜

ä½¿ç”¨æ ‡å‡†çš„ crontab æ ¼å¼ï¼š`åˆ† æ—¶ æ—¥ æœˆ å‘¨`

```
* * * * *
â”‚ â”‚ â”‚ â”‚ â”‚
â”‚ â”‚ â”‚ â”‚ â””â”€â”€ æ˜ŸæœŸå‡  (0-7, 0 å’Œ 7 éƒ½è¡¨ç¤ºå‘¨æ—¥)
â”‚ â”‚ â”‚ â””â”€â”€â”€â”€ æœˆä»½ (1-12)
â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€ æ—¥æœŸ (1-31)
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€ å°æ—¶ (0-23)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ åˆ†é’Ÿ (0-59)
```

ç¤ºä¾‹ï¼š
- `*/5 * * * *` - æ¯ 5 åˆ†é’Ÿ
- `0 * * * *` - æ¯å°æ—¶æ•´ç‚¹
- `0 9 * * *` - æ¯å¤©ä¸Šåˆ 9 ç‚¹
- `0 0 * * 0` - æ¯å‘¨æ—¥åˆå¤œ

## æ—¥å¿—

æ—¥å¿—æ–‡ä»¶ä¿å­˜åœ¨ `logs/` ç›®å½•ä¸­ï¼ŒæŒ‰æ—¥æœŸå‘½åï¼š
- `hydrus_tagger_2024-01-01.log`
- `hydrus_tagger_2024-01-02.log`
- ...

æ—¥å¿—ä¼šè‡ªåŠ¨è½®è½¬ï¼Œå•ä¸ªæ–‡ä»¶æœ€å¤§ 10MBï¼Œä¿ç•™ 5 ä¸ªå¤‡ä»½ã€‚

## å®¹å™¨åŒ–è¿è¡Œ

### Dockerfile ç¤ºä¾‹

```dockerfile
FROM python:3.10-slim

WORKDIR /app

COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

COPY . .

CMD ["python", "run.py"]
```

### docker-compose.yml ç¤ºä¾‹

```yaml
version: '3.8'

services:
  hydrus-tagger:
    build: .
    volumes:
      - ./config.json:/app/config.json
      - ./logs:/app/logs
      - ./models:/app/models
    restart: unless-stopped
```

## ä¼˜é›…å…³é—­

ç¨‹åºæ”¯æŒä¼˜é›…å…³é—­ï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼åœæ­¢ï¼š

- å‘é€ `SIGTERM` ä¿¡å·ï¼ˆå®¹å™¨ç¯å¢ƒï¼‰
- å‘é€ `SIGINT` ä¿¡å·ï¼ˆCtrl+Cï¼‰

ç¨‹åºä¼šç­‰å¾…å½“å‰ä»»åŠ¡å®Œæˆåé€€å‡ºã€‚

## é”™è¯¯å¤„ç†

- å•ä¸ªæ–‡ä»¶å¤„ç†å¤±è´¥ä¸ä¼šå½±å“æ•´ä½“è¿è¡Œ
- æ‰€æœ‰é”™è¯¯éƒ½ä¼šè®°å½•åˆ°æ—¥å¿—æ–‡ä»¶ä¸­
- å¤±è´¥çš„æ–‡ä»¶ä¸ä¼šé‡è¯•ï¼ˆå¯åœ¨æ—¥å¿—ä¸­æŸ¥çœ‹ï¼‰

## ç»Ÿè®¡ä¿¡æ¯

ç¨‹åºä¼šè®°å½•ä»¥ä¸‹ç»Ÿè®¡ä¿¡æ¯ï¼š
- æ€»å¤„ç†æ–‡ä»¶æ•°
- æˆåŠŸæ•°é‡
- å¤±è´¥æ•°é‡
- æœ€åè¿è¡Œæ—¶é—´
- ä¸‹æ¬¡è¿è¡Œæ—¶é—´

## æ¨¡å‹

é»˜è®¤ä½¿ç”¨ `SmilingWolf/wd-eva02-large-tagger-v3` æ¨¡å‹ã€‚æ”¯æŒçš„æ¨¡å‹åŒ…æ‹¬ï¼š

- `SmilingWolf/wd-eva02-large-tagger-v3` (æ¨è)
- `SmilingWolf/wd-vit-large-tagger-v3`
- `SmilingWolf/wd-swinv2-tagger-v3`
- `SmilingWolf/wd-convnext-tagger-v3`
- æ›´å¤šæ¨¡å‹è¯·å‚è€ƒ [WD14 Tagger](https://github.com/toriato/stable-diffusion-webui-wd14-tagger)

## è®¸å¯è¯

MIT License

## è´¡çŒ®

æ¬¢è¿æäº¤ Issue å’Œ Pull Requestï¼

